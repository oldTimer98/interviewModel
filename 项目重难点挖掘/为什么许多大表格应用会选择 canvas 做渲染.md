google sheet、腾讯、飞书、钉钉等表格应用都从 dom 方式迁移到 canvas 方案，这甚至可以说是大表格(**数百万行**)演化的一个重要方向了

## 为什么

- 超大表格需要渲染非常非常多 内容，也就是非常多 dom 节点，必然会带来渲染性能问题
- dom 方案下可以使用虚拟滚动等优化渲染性能，但依然受限于浏览器**过剩**的排版规则，必然会有不少性能浪费

- ps：浏览器 css + html 是一种通用强大的内容排版引擎，功能强大但在表格场景下势必会带来一些浪费

- 使用 canvas 方案后，虽然开发成本非常高，但可以完全自定义实现排版规则，能规避浏览器频繁重绘重排、dom 节点消耗性能较大等问题，性能上限会更高

## 怎么做

具体写法很复杂：

- 使用开源组件，如 antv/s2 渲染表格内容
- 自己划线框图，并在每一个 cell 中划文本/图片内容

## 项目难点

- dom 方案的问题(对技术细节的理解深度)：

- **重排规则**比较黑盒，优化空间有限
- 大量 dom 会非常消耗页面内存
- 虚拟滚动依然需要大量销毁重建
- 多端场景需要做好代码兼容(小程序)
- 表格场景通常并不需要过多花里胡哨的内容表现力，浏览器提供的渲染能力有点过剩了

- canvas 方案的问题(最大优势在于灵活性极高，可以做到非常高的性能上限，但编码成本非常高，难度大)：

- 文本折行、文本居中、文本样式等
- 布局(单元格行高、列宽等)、行/列冻结
- 滚动渲染
- 单元格编辑、复制粘贴
- 。。。

- 可行性：just do it

- 表格应用通常数据量庞大，但交互规则较单一(例如不需要太多交互特效，太多特殊样式)
- canvas 就像一个高度灵活的画笔，没有 dom 那样条条框框的渲染规则，灵活度极高，问题不在于它能不能做，而是怎么做
- 注意做好 canvas 性能优化

- 只渲染可视区域的内容
- 单元格边界线尽可能用一次指令完成
- 某些场景纯粹用 canvas 可能性能成本反而更高，因此可以 canvas + dom 混用(例如阴影，可以用 dom 渲染阴影效果后附加到 canvas 特定位置上)
- 离屏 canvas 配合 webworker，渲染完毕后传输回主线程
- 图表分层



资料：

- https://github.com/Wscats/sheet
- https://github.com/SheetJS/sheetjs
- https://github.com/dream-num/Luckysheet
- https://github.com/antvis/S2
- https://zhuanlan.zhihu.com/p/490076733
- [https://juejin.cn/post/7072926133859123236](https://juejin.cn/post/7072926133859123236#heading-8)
- https://zhuanlan.zhihu.com/p/340423350
- https://developer.aliyun.com/article/783326