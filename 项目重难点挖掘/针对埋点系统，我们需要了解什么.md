是什么、为什么、怎么做，难点及对应解决方案

## 埋点是什么？为什么需要埋点？

所谓埋点就是在应用中特定的流程**收集一些信息**，用来跟踪应用使用的状况，后续用来进一步优化产品或是提供运营的数据支撑，包括停留时长（Time On Site），页面浏览数（Page Views）和用户点击按钮的频次等。

通过埋点，我们可以：

- **洞察用户体验**：应用、功能模块的使用情况，比如有多少人用、是否顺畅、是否符合业务流程设定等；
- **排查与定位问题**：用户遇到什么问题，收集解决问题的有效信息等；
- **辅助业务决策**：辅助实现 A/B test、业务策略调整、转化率分析等；



简单而言，埋点**可以帮助我们更好的收集用户特定的信息与数据，帮助我们进行用户行为分析，辅助业务决策。**

**简明埋点流程：**

![img](https://cdn.nlark.com/yuque/0/2023/png/311219/1694515299257-267e57d8-0ad6-4622-8409-2d02810eb994.png)

一般而言，埋点的核心目的在于性能监控与数据监控以及错误监控：

### 性能监控

在小项目时，由于用户数量不多，大家觉得过得去就行，而当用户数量激增以后，性能监控，就显得非常重要，因为，这样你能就能知道潜在的一些问题和bug，并且能快速迭代，获得更好的用户体验！一般情况下，我们在性能监控时需要注意那么几点：

- 白屏时长
- 页面的 LCP、TTI、FP 等核心指标上报
- 重要页面的渲染时间
- 首屏加载时长等
- 接口响应时长上报

### 数据监控

所谓数据监控就是能拿到用户的行为，我们也需要注意那么几点：

- PV访问来量（Page View）
- UV访问数（Unique Visitor）
- 记录操作系统和浏览器
- 记录用户在页面的停留时间
- 进入当前页面的来源网页（也就是从哪进来的转化）
- 接口返回数据监控

### 错误监控

页面发生的所以错误相关的内容在捕获后进行埋点上报：

- JS Error
- 请求 Error
- 资源加载 Error
- 框架 Error
- 异步 Error

## 怎么做

前端常见的埋点请求发送方案有以下几种：

1. **直接发送请求**：通过 XMLHttpRequest（XHR）或 Fetch API 直接发送埋点请求。可以在埋点代码中构建相关数据，比如用户信息、页面信息和事件信息，然后以 GET 或 POST 请求方式发送给后端接收和处理。
2. **图像请求**：利用浏览器的 Image 对象，创建一个图片请求并将埋点数据作为 URL 中的参数传递。后端接收到该请求后会记录相关数据。这种方式通常用于跨域请求或者简单的埋点需求，不需要关注返回结果。
3. **Beacon** **API**：使用 Beacon API 可以在页面卸载时异步地发送埋点请求，不会阻塞页面的卸载过程。Beacon API 适用于一些无需等待服务器响应的快速埋点需求，比如发送一些统计数据。
4. **WebSocket**：通过 WebSocket 建立与后端的持久连接，将埋点数据作为消息发送给后端。WebSocket 可以实现实时埋点数据的发送和接收，并且对数据量较大、需要实时反馈和双向通信的场景更为适用。

| **埋点****方式**          | **成本** | **兼容性** | **场景**                           | （致命）**缺点**                                             | **核心优点**                                                 |
| ------------------------- | -------- | ---------- | ---------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 直接发送请求（XHR/Fetch） | 中       | 较好       | 无法兼顾部分特殊场景：浏览器关闭等 | 需要考虑跨域问题。可能会阻塞页面加载或渲染，影响用户体验。   | 易于实现，能获取响应结果。                                   |
| 图像请求                  | 低       | 较好       | 无法兼顾部分特殊场景：浏览器关闭等 | 难以获取请求的状态和响应结果。不适合需要实时反馈和复杂数据传输的场景。 | 无需考虑跨域问题不会阻塞页面加载                             |
| Beacon API                | 低       | 低         | 能兼顾特殊场景：浏览器关闭等       | 仅支持部分浏览器，兼容性有限。可能无法获取响应结果。         | 页面卸载时可异步地发送埋点请求不会阻塞页面的卸载过程         |
| WebSocket                 | 高       | 较好       | 无法兼顾部分特殊场景：浏览器关闭等 | 相对复杂，需要客户端和服务器端的双向实现。                   | 实时性好，支持双向通信，适用于需要大量、实时、双向交互的埋点需求 |

**核心点：**

1. **目前最常见的方式是使用图像请求与直接发送请求，但是它们各自存在优缺点（对于它们的优缺点需要牢记于心！）**
2. Beacon API 用于解决特定场景下的问题，但是可能存在兼容性问题



### 扩展问题

1. <script> 标签和 <link> 标签的 src 属性也可以实现跨域，为什么通常会使用 <img> 的 src 进行上报 而不是 <script> 标签和 <link> 标签？

答：当我们使用 script 和 link 进行埋点上报时，需要将生成的 script 标签和 link 标签挂载到页面上，相应的 src 请求才会发出！而 img 标签需要将相应标签挂载到页面上，只需要设置 img.src = xxx 即可完成上报请求的发送。

所以 <script> 标签和 <link> 需要反复操作 dom ，因此会对页面性能造成较大影响，而且载入 js/css 资源还会阻塞页面渲染，影响用户体验，因此对于需要频繁上报的埋点而言，script 和 link 并不合适。



## 埋点进阶

思考一下，普通的埋点方式流程：

1. 找到需要进行埋点上报的地方
2. 在相应位置插入埋点上报相关代码
3. 提交、发版，埋点生效

**上述流程有没有什么问题？**

**答：**基于上述的普通埋点方案，存在两个比较严重的问题：

1. **埋点代码与业务代码相耦合**
2. **每次新增埋点需要发版**

**那么，可以如何有效解决上述问题？**

给予上述几个问题，业界基于最普通的埋点方式，衍生出了几种不同的埋点方案，常见的埋点方案如下：

|      | **侵入式代码****埋点**                                       | **配置化埋点（可视化埋点）**                                 | **无痕埋点（无埋点、全埋点）**                               |
| ---- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 说明 | 嵌入代码的形式进行埋点，比如说监控按钮的点击事件，则在按钮点击时调一下上报的方法。 | 通过配置化声明或可视化交互的的手段，生成上报规则，在页面运行到相应时机并匹配对应逻辑时，上报数据。 | 所有的事件都记录上报，配合文件解析，展示所需要的数据         |
| 优点 | **精准控制、精准传输**。在任意时刻精确地发送所需要的数据信息。 | **与业务代码解耦**通常不需要发版本即可更新点位               | **数据全量采集**，不会漏埋与业务代码解耦                     |
| 缺点 | **工作量大**每次更新都要改代码，可能会出现错埋、漏埋。埋点代码与业务代码相互耦合 | 覆盖范围有限，仅能基于浏览器事件**数据获取不灵活**           | **数据量过大**数据获取不灵活，无法实现一些特殊逻辑**不容易拿到一些埋点位置的上下文数据（譬如上报同时上报页面上的某个 ID）** |

**核心点：**

1. 上述的**侵入式代码埋点，就是最普通的埋点方案。**
2. 了解**侵入式代码埋点、配置化埋点（可视化埋点）、无痕埋点**三种埋点方案的对比，思考如何基于他们进行埋点方案的优化演化，以及他们各自的优缺点
3. 可以通过三种埋点方式的组合使用，突出自己在埋点过程中，**基于问题不断对方案进行演化优化的过程**
4. **埋点只是引子，能够通过埋点引申到整个前端的体系化监控（埋点、上报、数据入库、清洗、可视化展示、监控告警），能拿到更高的分数！**

1. 譬如，基于埋点，如何设计数据入库？埋点数据应该选择什么数据库？MySQL、ES、ClickHouse？
2. 如何设计上报协议？是否有考虑过性能和扩展性？
3. 是否有过数据清洗的经验？搞过前端自己的 BFF 进行数据清洗吗？
4. 如何做数据的可视化展示？Kibana、Grafana 用过吗？
5. 如何做埋点数据的检索？了解或者实操过 ELK 套件吗？
6. 如何做监控数据的告警？制定过那些告警指标？