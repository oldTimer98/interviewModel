数据敏感场景希望能为页面添加文字水印，在用户截图、拍照等导致信息泄露之后，依然能有效追溯

场景：语雀、飞书文档、腾讯云文档、阿里内部论坛(月饼事件)

注意：这里说的是整个 web 页面，不是单纯图片、文档等，这是不同的问题；其次，这里说的是 明水印，暗水印会复杂许多，我们单独拉一个篇章出来说

本质上，就是在页面基本内容之上叠加有标识作用的内容

![img](https://cdn.nlark.com/yuque/0/2022/png/26698409/1667059024405-68bf2c7b-979b-4ed8-9e1a-ccb41b265915.png)

### 方案一：纯 html

最基础的方案，实用性不高，了解原理即可

- 基本原理：

- 需要提供一个水印容器元素，注意 z-index 在最上面，`point-event: none`、position: fixed 等，并铺满全屏
- 根据屏幕宽高，渲染若干水印元素，铺满全屏

- 问题：

- js、css、html 三者逻辑耦合度高
- 实现逻辑很啰嗦，其实真不太优雅
- 整体性能并不太高

```javascript
function printWatermark() {
    const waterHeight = 100;
    const waterWidth = 100;
    const {
        clientWidth,
        clientHeight
    } = document.documentElement || document.body;
    const column = Math.ceil(clientWidth / waterWidth);
    const rows = Math.ceil(clientHeight / waterHeight);
    const root = document.getElementsByClassName('watermark')[0]
    for (let i = 0; i < column * rows; i++) {
        const ele = document.createElement('div');
        ele.textContent = 'bin'
        ele.classList.add('watermark-item');
        root.appendChild(ele)
    }
}
printWatermark()
```

### 方案二：canvas + dom

- 基本原理：

- 通过 canvas 填充文本，并通过 `canvas.toDataURL("image/png");` 获取到图片对应的 base64 值
- 将这个 base64 格式的图片作为类名为 watermark 节点的背景图，并设置 `background-repeat: repeat;` 

- 缺点：

- 放大效果较差，有明显锯齿

```javascript
function mountWatermark() {
    const createWatermarkCtx = () => {
        const txt = 'bin',
            width = 100,
            height = 100,
            x = 10,
            y = 10,
            fontSize = 14,
            color = 'red',
            alpha = 1,
            angle = -20;
        const svgStr =
            `<svg xmlns="http://www.w3.org/2000/svg" width="${width}px" height="${height}px">
        <text x="${x}px" y="${y}px" dy="${fontSize}px"
            text-anchor="start"
            stroke="${color}"
            stroke-opacity="${alpha}"
            fill="none"
            transform="rotate(${angle},${x} ${y})"
            font-weight="100"
            font-size="${fontSize}"
            font-family="sans-serif"
            >
            ${txt}
        </text>
    </svg>`;
        return `data:image/svg+xml;base64,${window.btoa(unescape(encodeURIComponent(svgStr)))}`;
    }
    const watermark = document.createElement('div');
    watermark.className = 'watermark';
    watermark.style.backgroundImage = `url(${createWatermarkCtx()})`
    document.body.appendChild(watermark);

    // 防止水印节点被删除
    const observer = new MutationObserver((mutationsList, observer) => {
        for (let mutation of mutationsList) {
            mutation.removedNodes.forEach(function (item) {
                if (item === watermark) {
                    document.body.appendChild(watermark);
                }
            });
        }
    });
    observer.observe(document.body, {
        attributes: true,
        childList: true,
        subtree: true
    });
}
mountWatermark();
```



### 方案三：svg

- 基本原理：与 canvas + dom 方式相同，本质上都是借助 svg/canvas 生成水印图，但相比 canvas，缩放效果好很多

```javascript
function mountWatermark() {
    const createWatermarkCtx = () => {
        const angle = -20;
        const txt = 'bin'
        const canvas = document.createElement('canvas');
        canvas.width = 100;
        canvas.height = 100;
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, 100, 100);
        ctx.fillStyle = 'red';
        ctx.font = `16px serif`;
        ctx.rotate(Math.PI / 180 * angle);
        ctx.fillText(txt, 0, 50);
        // 重点
        return canvas.toDataURL();
    }
    const watermark = document.createElement('div');
    watermark.className = 'watermark';
    watermark.style.backgroundImage = `url(${createWatermarkCtx()})`
    document.body.appendChild(watermark);
}
mountWatermark();
```



### 破解水印

典型的防君子不防小人

- 打开 devtools ，删除对应节点，或修改节点 `display: none`，删除 class 等

- 使用 mutationobserver 监听页面变更，防止水印节点被删除

- 浏览器配置中，关闭 js，然后删除对应节点
- charles 拦截请求，并删除水印相关代码
- 。。。
- 怎么办？暗水印！隐蔽性、抵抗攻击的能力都会强上许多



资料：

- https://segmentfault.com/a/1190000038365780
- https://www.zhangxinxu.com/wordpress/2011/12/css3-pointer-events-none-javascript/