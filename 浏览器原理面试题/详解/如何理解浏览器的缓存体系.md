只能回答强缓存 and 协商缓存？No!

## 是什么

浏览器中可以按照一定缓存策略，将网络资源存储到本地，下次再次请求时直接使用本地副本，避免二次加载



## 为什么

网络 io 速度很慢，很贵！借助缓存机制可对相同资源做不必要的重复加载，节省网络时间与流量



## 怎么做

**浏览器缓存的全过程：**

- 浏览器第一次加载资源，服务器返回 200，浏览器从服务器下载资源文件，并缓存资源文件与 response header，以供下次加载时对比使用；
- 下一次加载资源时，由于强制缓存优先级较高，先比较当前时间与上一次返回 200 时的时间差，如果没有超过 cache-control 设置的 max-age，则没有过期，并命中强缓存，直接从本地读取资源。如果浏览器不支持HTTP1.1，则使用 expires 头判断是否过期；
- 如果资源已过期，则表明强制缓存没有被命中，则开始协商缓存，向服务器发送带有 If-None-Match 和 If-Modified-Since 的请求；
- 服务器收到请求后，优先根据 Etag 的值判断被请求的文件有没有做修改，Etag 值一致则没有修改，命中协商缓存，返回 304；如果不一致则有改动，直接返回新的资源文件带上新的 Etag 值并返回 200；
- 如果服务器收到的请求没有 Etag 值，则将 If-Modified-Since 和被请求文件的最后修改时间做比对，一致则命中协商缓存，返回 304；不一致则返回新的 last-modified 和文件并返回 200；

![img](https://cdn.nlark.com/yuque/0/2021/png/1500604/1618399660902-60a33dae-cedc-4bd0-9a5b-160c5da3f516.png)

很多网站的资源后面都加了版本号，这样做的目的是：每次升级了 JS 或 CSS 文件后，为了防止浏览器进行缓存，强制改变版本号，客户端浏览器就会重新下载新的 JS 或 CSS 文件 ，以保证用户能够及时获得网站的最新更新。



此外，浏览器实现上会将不同内容缓存到不同位置：

- 内存缓存：直接将内容存储在内存中，效率非常高，可以实现 0ms 响应，但容量很少；

- 优点：

- 速度非常快	

- 缺点：

- 各家浏览器自行实现，非 w3c 标准，表现不一定对齐
- 规则比较黑盒，例如缓存空间上限、哪些内容能够被缓存等，或者说对开发者而言似乎并不需要关心这些差异
- 优先级高于 sw，因此会影响 sw 表现
- 缓存生命周期较短，页面关闭后所有内存缓存自动失效

- ServiceWorker 实现缓存：若没有命中内存缓存，浏览器会尝试使用 ServiceWorker；可用于自定义缓存策略，响应时间大概在 10ms 量级，容量相对较大；

```css
self.addEventListener("fetch", (event) => {
  event.respondWith(
    (async function () {
      // 从 HTTP 缓存或者网络获取资源
      const res =  fetch(event.request);
      
      // 因为 Response 是一个流，只能用一次，所以这里要 clone 一下。
      const newRes = res.clone();
      
      // 改写资源响应头
            return new Response(res.body, { ...newRes, headers: {
        'cache-control': 'max-age=0'
      }});
    })();
  );
});
```

- 优点：

- 可由开发者自定义网络请求的处理逻辑，自行定义缓存哪些文件、如何匹配缓存、如何读取缓存等
- 不依赖网络，断网时依然可以使用(这也正是 pwa 了)
- 可以实现更细粒度的控制，在使用 http 缓存时你只能选择缓存或不缓存，使用 sw 则可以根据情况 —— 例如网络连通度，决定是否使用缓存副本
- 与 http 缓存体系互不影响
- 不受浏览器缓存策略影响，这意味着用户手动清楚缓存(如 disable cache)后，sw 缓存依然生效

- 缺点：

- sw 夹在 mc、dc 之间，若资源命中 mc，则 sw 根本感知不到该请求
- sw 灵活性较高，但代价则是需要我们自行开发缓存逻辑
- 需要自行维护缓存删除逻辑
- 完全由前端控制，服务端无法介入

- 硬盘缓存：若未命中 ServiceWorker 逻辑，则尝试使用硬盘缓存，响应时间大概 10ms 量级，容量最大；

- 优点：

- 基本等同于 http 缓存的能力，空间大，存储时间长，不需要开发者介入，等等

- 缺点：

- 读取速度相对较慢
- 强依赖于网络环境
- 强缓存场景下，无法删除缓存资源 —— 除非站点缓存空间达到上限

- 无缓存：使用网络资源，响应时间视情况而定，经验值大概 100ms 左右；当然了，容量接近无限。

![img](https://cdn.nlark.com/yuque/0/2022/png/26698409/1664885105097-c261ff2f-252e-4bb1-8a4d-227908e3176b.png)



资料：

- https://segmentfault.com/a/1190000041736677
- https://web.dev/i18n/zh/service-worker-caching-and-http-caching/